{{ define "main" }}
<article class="post-single">
  <header class="post-header">
    <div class="header-controls">
      <h1 class="post-title">{{ .Title }}</h1>
      <div class="accessibility-controls">
        <button id="themeToggle" class="control-btn" aria-label="Toggle theme">
          <span class="icon-light">‚òÄÔ∏è</span>
          <span class="icon-dark">üåô</span>
        </button>
        <button id="colorBlindToggle" class="control-btn" aria-label="Toggle color blind mode">
          <span>üëÅÔ∏è</span>
        </button>
      </div>
    </div>
  </header>
  <div class="post-content">
    {{ .Content }}
    
    <div class="calendar-container">
      
      <!-- Month Navigation -->
      <div class="calendar-header-section">
        <button id="backToToday" class="back-btn" aria-label="Back to today">
          <span class="back-arrow">‚Üê</span>
          <span class="year-display" id="yearDisplay"></span>
        </button>
        <div class="month-controls">
          <button id="prevMonth" class="month-nav-btn" aria-label="Previous month">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"/>
            </svg>
          </button>
          <h2 class="month-title" id="currentMonthYear"></h2>
          <button id="nextMonth" class="month-nav-btn" aria-label="Next month">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"/>
            </svg>
          </button>
        </div>
        <div class="header-actions">
          <button class="view-toggle-btn" id="viewToggle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
            </svg>
          </button>
          <button class="search-btn" aria-label="Search events">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
          </button>
          <button class="add-btn" aria-label="Add event">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Calendar Grid -->
      <div class="calendar-month-view">
        <h3 class="month-name" id="monthNameLarge"></h3>
        <div class="weekday-headers">
          <div class="weekday-header">S</div>
          <div class="weekday-header">M</div>
          <div class="weekday-header">T</div>
          <div class="weekday-header">W</div>
          <div class="weekday-header">T</div>
          <div class="weekday-header">F</div>
          <div class="weekday-header">S</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>
      
      <!-- Events List -->
      <div class="events-section">
        <div class="events-header">
          <div class="selected-date-badge" id="selectedDateBadge"></div>
        </div>
        <div class="events-list" id="eventsList"></div>
      </div>
      
      <!-- Bottom Navigation (Mobile) -->
      <div class="bottom-nav">
        <button class="bottom-nav-btn active">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <path d="M16 2v4M8 2v4M3 10h18"/>
          </svg>
          <span>Today</span>
        </button>
        <button class="bottom-nav-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          </svg>
          <span class="badge">2</span>
        </button>
      </div>
    </div>
  </div>
</article>

<script>
  // Theme and accessibility management
  const themeManager = {
    currentTheme: localStorage.getItem('calendar-theme') || 'auto',
    colorBlindMode: localStorage.getItem('color-blind-mode') === 'true',
    
    init() {
      this.applyTheme();
      this.applyColorBlindMode();
      this.setupListeners();
    },
    
    applyTheme() {
      const html = document.documentElement;
      if (this.currentTheme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        html.setAttribute('data-theme', this.currentTheme);
      }
      this.updateThemeButton();
    },
    
    applyColorBlindMode() {
      document.documentElement.classList.toggle('color-blind-mode', this.colorBlindMode);
      const btn = document.getElementById('colorBlindToggle');
      if (btn) btn.classList.toggle('active', this.colorBlindMode);
    },
    
    updateThemeButton() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const btn = document.getElementById('themeToggle');
      if (btn) btn.classList.toggle('dark', isDark);
    },
    
    toggleTheme() {
      const themes = ['light', 'dark', 'auto'];
      const currentIndex = themes.indexOf(this.currentTheme);
      this.currentTheme = themes[(currentIndex + 1) % themes.length];
      localStorage.setItem('calendar-theme', this.currentTheme);
      this.applyTheme();
    },
    
    toggleColorBlind() {
      this.colorBlindMode = !this.colorBlindMode;
      localStorage.setItem('color-blind-mode', this.colorBlindMode);
      this.applyColorBlindMode();
    },
    
    setupListeners() {
      document.getElementById('themeToggle')?.addEventListener('click', () => this.toggleTheme());
      document.getElementById('colorBlindToggle')?.addEventListener('click', () => this.toggleColorBlind());
      
      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (this.currentTheme === 'auto') this.applyTheme();
      });
    }
  };

  // Load event data from Hugo data files
  const eventData = {};
  {{ range $filename, $data := .Site.Data.aggregate_feed }}
    eventData['{{ $filename }}'] = JSON.parse({{ $data | jsonify }});
  {{ end }}

  console.log('Event data loaded:', eventData);

  // Parse all events and organize by date
  const eventsByDate = {};
  const eventColors = ['blue', 'orange', 'pink', 'purple', 'green', 'red', 'yellow', 'teal'];
  
  Object.keys(eventData).forEach(key => {
    eventData[key].forEach(event => {
      const eventDate = new Date(event.start);
      const dateKey = eventDate.toISOString().split('T')[0];
      
      if (!eventsByDate[dateKey]) {
        eventsByDate[dateKey] = [];
      }
      
      // Assign a color based on event summary hash
      const colorIndex = Math.abs(event.summary.split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
      }, 0)) % eventColors.length;
      
      eventsByDate[dateKey].push({
        summary: event.summary,
        start: new Date(event.start),
        end: new Date(event.end),
        color: eventColors[colorIndex]
      });
    });
  });

  // Sort events by start time
  Object.keys(eventsByDate).forEach(date => {
    eventsByDate[date].sort((a, b) => a.start - b.start);
  });

  let currentDate = new Date();
  let selectedDate = null;

  function renderCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Update headers
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    document.getElementById('currentMonthYear').textContent = monthNames[month];
    document.getElementById('monthNameLarge').textContent = monthNames[month];
    document.getElementById('yearDisplay').textContent = year;
    
    // Clear calendar grid
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    
    // Add empty cells for days before the first of the month
    for (let i = 0; i < startingDayOfWeek; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.className = 'calendar-day empty';
      calendarGrid.appendChild(emptyDay);
    }
    
    // Add days of the month
    const today = new Date();
    const todayDateKey = today.toISOString().split('T')[0];
    
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dateKey = date.toISOString().split('T')[0];
      const dayEvents = eventsByDate[dateKey] || [];
      
      const isToday = dateKey === todayDateKey;
      const isSelected = selectedDate && dateKey === selectedDate.toISOString().split('T')[0];
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      if (isToday) dayCell.classList.add('today');
      if (isSelected) dayCell.classList.add('selected');
      if (dayEvents.length > 0) dayCell.classList.add('has-events');
      
      // Create day number with today indicator
      const dayNumber = document.createElement('div');
      dayNumber.className = 'day-number';
      if (isToday) {
        dayNumber.innerHTML = `<span class="today-circle">${day}</span>`;
      } else {
        dayNumber.textContent = day;
      }
      dayCell.appendChild(dayNumber);
      
      // Add event indicators (max 3)
      if (dayEvents.length > 0) {
        const indicatorsContainer = document.createElement('div');
        indicatorsContainer.className = 'event-indicators';
        
        const maxIndicators = 3;
        dayEvents.slice(0, maxIndicators).forEach(event => {
          const indicator = document.createElement('div');
          indicator.className = `event-dot ${event.color}`;
          indicator.title = event.summary;
          indicatorsContainer.appendChild(indicator);
        });
        
        if (dayEvents.length > maxIndicators) {
          const more = document.createElement('div');
          more.className = 'event-more';
          more.textContent = `+${dayEvents.length - maxIndicators}`;
          indicatorsContainer.appendChild(more);
        }
        
        dayCell.appendChild(indicatorsContainer);
      }
      
      dayCell.addEventListener('click', () => showEvents(date, dateKey));
      calendarGrid.appendChild(dayCell);
    }
    
    // Show events for selected date or today
    if (!selectedDate) {
      if (eventsByDate[todayDateKey]) {
        showEvents(today, todayDateKey);
      } else {
        showEvents(today, todayDateKey);
      }
    }
  }

  function showEvents(date, dateKey) {
    selectedDate = date;
    const events = eventsByDate[dateKey] || [];
    
    // Update all selected states
    document.querySelectorAll('.calendar-day').forEach(day => {
      day.classList.remove('selected');
    });
    
    // Add selected class to clicked day
    event?.target?.closest('.calendar-day')?.classList.add('selected');
    
    // Format date for badge
    const dayNum = date.getDate();
    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
    
    const badge = document.getElementById('selectedDateBadge');
    badge.innerHTML = `
      <div class="date-day">${dayName}</div>
      <div class="date-num">${dayNum}</div>
    `;
    
    const eventsList = document.getElementById('eventsList');
    
    if (events.length === 0) {
      eventsList.innerHTML = `
        <div class="no-events">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <path d="M16 2v4M8 2v4M3 10h18"/>
          </svg>
          <p>No events</p>
        </div>
      `;
      return;
    }
    
    eventsList.innerHTML = events.map(event => {
      // Check if all-day event
      const isAllDay = event.start.getHours() === 0 && 
                      event.end.getHours() === 0 && 
                      (event.end - event.start) >= 86400000;
      
      let timeDisplay;
      if (isAllDay) {
        timeDisplay = 'all-day';
      } else {
        const startTime = event.start.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        const endTime = event.end.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        timeDisplay = `${startTime} ‚Äì ${endTime}`;
      }
      
      return `
        <div class="event-item ${event.color}">
          <div class="event-color-bar"></div>
          <div class="event-content">
            <div class="event-time">${timeDisplay}</div>
            <div class="event-title">${event.summary}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
  }

  function goToToday() {
    currentDate = new Date();
    selectedDate = null;
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
  }

  // Initialize
  themeManager.init();
  renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
</script>

{{ end }}